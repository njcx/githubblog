Title: NIDS开发之IP分片重组和TCP段重组
Date: 2024-10-29 20:20
Modified: 2024-10-29 20:20
Category: 安全
Tags: 企业安全建设
Slug: T6
Authors: nJcx
Summary: NIDS开发之IP分片重组和TCP段重组 ~

#### 介绍

NIDS（Network Intrusion Detection System，网络入侵检测系统）开发过程中，主要拆解成两个部分开发， 第一的DPI深度包解析，第二就是规则引擎。DPI深度包解析是指NIDS通过监听网络流量来捕捉数据包、协议识别、拆解成字段过程。这些数据包包含了从网络的一个点传输到另一个点的信息。DPI是NIDS分析网络活动以检测潜在入侵行为的基础步骤， 捕捉数据包的工具有 libpcap 、PF_RING、DPDK等等。DPI深度包解析工具有PacketBeat、NDPI、Zeek等等


在TCP/IP协议栈中，数据包的重组主要涉及两个方面：IP分片重组和TCP段重组。

IP分片重组：当一个IP数据报由于过大而无法在一个物理网络上进行传输时，它可能会被分成多个较小的片段（分片），每个分片作为一个独立的IP数据报进行传输。这些分片最终需要在目的地处重新组装成原始的数据报。这个过程称为IP分片重组。IP头部包含了一个标识字段、一个标志字段和一个分片偏移字段，它们共同作用以帮助目的主机正确地重组这些分片。

TCP段重组：TCP（传输控制协议）是面向连接的，并提供可靠的数据传输服务。在数据传输过程中，发送方可能会将数据分割成多个TCP段进行发送。因为网络中的路由和延迟不同，这些TCP段可能不会按照它们被发送的顺序到达接收方。TCP使用序列号和确认机制来确保所有发送的数据都能够按照正确的顺序被重组。接收方根据序列号对收到的TCP段进行排序，并在必要时等待丢失段的重传，从而实现数据的正确重组。


为什么NIDS 涉及到IP分片重组和TCP段重组 ？ 这些不是TCP/IP协议栈的事情吗？
因为NIDS使用 libpcap 或者 DPDK， 抓取的都是一帧， 一个IP分片通常被封装成一帧进行传输。 当数据比较大的时候，比如 http post 一个稍大的json，  先经过 IP分片重组， 再经过TCP段重组，才能看到完整的 json。在TCP/IP协议栈中， 每一层对上都是透明的， 而在NIDS 中，每一层都需要自己重组。



IP分片和TCP分段是一回事吗 ？

IP分片和TCP分段不是一回事，它们是发生在网络协议栈不同层次的数据切分机制，但存在交叉。具体区别如下：

	IP分片：发生在网络层，由IP协议处理，由于网络链路层的MTU（最大传输单元）限制，当IP数据报大小超过MTU时，需要进行分片。
	TCP分片：发生在传输层，由TCP协议处理，为了适应MSS（最大分段大小），避免IP层分片，TCP会根据MSS对数据进行分段。



以下是一个具体的 同时包含 TCP 分段和 IP 分片的示例：


假设主机 A 要通过以太网向主机 B 发送一个总大小为 **4000 字节**的应用层数据。  

- 网络路径的 MTU（最大传输单元）为 **1500 字节**。
- TCP 的 MSS（最大分段大小）协商后为 **1460 字节**（即 1500 - 20(IP首部) - 20(TCP首部)）。
- IP 首部长度为 **20 字节**。

由于应用层数据的大小超过了 MSS 和 MTU 的限制，因此需要进行 **TCP 分段** 和 **IP 分片**。



1. 计算 TCP 分段数量

- 每个 TCP 数据段的最大有效载荷为 **1460 字节**。
- 总数据量为 **4000 字节**，因此需要分成：4000 ÷ 1460  = 3 


2. TCP 分段详细信息

| 分段编号 | 序列号范围   | 数据长度 | TCP 首部长度 | IP 首部长度 | 总长度 |
|----------|--------------|----------|--------------|-------------|--------|
| 第 1 段  | 1 ~ 1460     | 1460     | 20           | 20          | 1500   |
| 第 2 段  | 1461 ~ 2920  | 1460     | 20           | 20          | 1500   |
| 第 3 段  | 2921 ~ 4000  | 1080     | 20           | 20          | 1120   |



IP 分片过程

假设网络路径中某段链路的 MTU 仅为 **1000 字节**，而每个 TCP 分段的总长度（包括 TCP 和 IP 首部）都超过了该 MTU，因此需要对每个 TCP 分段进一步进行 **IP 分片**。


 1. 对第一段进行 IP 分片
 
  - 第一段的总长度为 **1500 字节**，需要分成两个 IP 分片：
  - **第一片**: 包含前 **980 字节**的数据（1000 - 20(IP首部)），加上 IP 首部，总长度为 **1000 字节**。
  - **第二片**: 包含剩余的 **500 字节**的数据（1500 - 1000），加上 IP 首部，总长度为 **520 字节**。
  

2. 对第二段进行 IP 分片

  - 第二段的总长度同样为 **1500 字节**，也需要分成两个 IP 分片：
  - **第一片**: 包含前 **980 字节**的数据，总长度为 **1000 字节**。
  - **第二片**: 包含剩余的 **500 字节**的数据，总长度为 **520 字节**。


3. 对第三段进行 IP 分片

  - 第三段的总长度为 **1120 字节**，也需要分成两个 IP 分片：
  - **第一片**: 包含前 **980 字节**的数据，总长度为 **1000 字节**。
  - **第二片**: 包含剩余的 **140 字节**的数据，总长度为 **160 字节**。



对比


| **阶段**      | **分段/分片编号** | **数据范围**      | **数据长度** | **总长度** | **偏移量** | **MF 标志位** |
|---------------|-------------------|-------------------|--------------|------------|------------|---------------|
| **TCP 分段**  | 第 1 段           | 1 ~ 1460         | 1460         | 1500       | N/A        | N/A           |
|               | 第 2 段           | 1461 ~ 2920      | 1460         | 1500       | N/A        | N/A           |
|               | 第 3 段           | 2921 ~ 4000      | 1080         | 1120       | N/A        | N/A           |
| **IP 分片**   | 第 1 段第 1 片    | 1 ~ 980          | 980          | 1000       | 0          | 1             |
|               | 第 1 段第 2 片    | 981 ~ 1460       | 500          | 520        | 122        | 0             |
|               | 第 2 段第 1 片    | 1461 ~ 2440      | 980          | 1000       | 185        | 1             |
|               | 第 2 段第 2 片    | 2441 ~ 2920      | 500          | 520        | 307        | 0             |
|               | 第 3 段第 1 片    | 2921 ~ 3900      | 980          | 1000       | 370        | 1             |
|               | 第 3 段第 2 片    | 3901 ~ 4000      | 140          | 160        | 485        | 0             |



重组过程

当主机 B 收到这些分片时：

1. 主机 B 根据 **标识符** 和 **偏移量** 将所有 IP 分片重组为完整的 TCP 分段。
2. 根据 **TCP 序列号** 将所有 TCP 分段按顺序拼接起来。
3. 最终得到完整的 **4000 字节** 数据，并交给应用层。



通过这个例子可以清楚地看到：

- **TCP 分段** 是基于 MSS 进行的，确保每个分段的总长度不超过 MTU。
- **IP 分片** 是基于实际网络路径的 MTU 进行的，确保每个分片的总长度不超过路径 MTU。
- 主机 B 通过 **TCP 序列号** 和 **IP 偏移量**，能够准确地将分片和分段重组为原始数据。


